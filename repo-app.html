<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/paper-styles/color.html">
<link rel="import" href="bower_components/paper-styles/typography.html">
<link rel="import" href="existdb-package-remove-action.html">
<link rel="import" href="existdb-package-install-action.html">


<!--
`repo-app`
element for displaying package metadata

@demo demo/doc.html
-->

<dom-module id="repo-app">
    <template>
        <style>
            :host {

                display: flex;
                flex-direction: row;
                padding: 30px;
                position: relative;
                background: white;
                margin-bottom:10px;
                border-top:1px solid var(--paper-grey-300);
                border-bottom:1px solid var(--paper-grey-300);
                min-height:70px;

                --paper-icon-button: {
                    color: var(--paper-blue-300);
                };


            }
            :host ::slotted(*){
                @apply(--paper-font-common-base);
            }

/*
            .wrapper {
                display: flex;
                flex-wrap:wrap;
            }

            .wrapper ::content > * {
                padding: 10px;
            }
*/

            paper-icon-button {
                min-height: 24px;
                min-width: 24px;
            }

            #info{
                position: absolute;
                top:10px;
                right:10px;
            }
            #install{
                position: absolute;
                top:10px;
                right:40px;
            }

            ::slotted(repo-icon){
                max-width:100px;
                display: inline-block;
            }
            ::slotted(repo-icon) img{
                max-width: 100px;
            }
            .wrapper{
                display: inline-block;
                padding-left:20px;
            }

            .wrapper ::slotted(repo-type){
                display:block;
                color:var(--paper-blue-700);
                font-size:12px;
                position:absolute;
                top:0px;
                padding-top:15px;
            }

            .wrapper ::slotted(repo-version)::before{
                content:"Version ";
            }
            .wrapper ::slotted(repo-title){
                font-size:24px;
                font-weight:500;
                margin:10px 0;
                display: inline-block;
                @apply(--paper-font-common-base);

            }
            .wrapper ::slotted(repo-version){
                display:table-row;
                width:100%;
                font-size:16px;
            }


            existdb-package-remove-action{
                position: absolute;
                top:10px;
                right:40px;
            }

            .wrapper ::slotted(repo-name),
            .wrapper ::slotted(repo-description),
            .wrapper ::slotted(repo-author),
            .wrapper ::slotted(repo-abbrev),
            .wrapper ::slotted(repo-license),
            .wrapper ::slotted(repo-website),
            .wrapper ::slotted(repo-url)
            {
                display:none;
            }

            .wrapper[show-all] ::slotted(repo-name),
            .wrapper[show-all] ::slotted(repo-description),
            .wrapper[show-all] ::slotted(repo-author),
            .wrapper[show-all] ::slotted(repo-abbrev),
            .wrapper[show-all] ::slotted(repo-license),
            .wrapper[show-all] ::slotted(repo-website),
            .wrapper[show-all] ::slotted(repo-url)
            {
                display:table-row;
            }

            .wrapper[show-all] ::slotted(*)::before{
                display: table-cell;
                min-width: 120px;
            }
            .wrapper[show-all] ::slotted(repo-name)::before{
                content: "Name: ";
            }
            .wrapper[show-all] ::slotted(repo-description)::before{
                content:"Description: ";
            }
            .wrapper[show-all] ::slotted(repo-author)::before{
                content:"Author:";
            }
            .wrapper[show-all] ::slotted(repo-abbrev)::before{
                content:"Abbreviation:";
            }
            .wrapper[show-all] ::slotted(repo-website)::before{
                content:"Website:";
            }
            .wrapper[show-all] ::slotted(repo-url)::before{
                content:"Url:";
            }
            .wrapper[show-all] ::slotted(repo-license)::before{
                content:"License:";
            }



        </style>
        <content select="repo-icon"></content>
        <div id="wrapper" class="wrapper" url="[[url]]">
            <!--<div class$="[[type]] type">[[type]]</div>-->
            <slot></slot>

            <!--todo: conditional template dependent on installed state. -->


            <!--todo: uninstall button for apps that are status=installed -->
            <existdb-package-remove-action id="remove" url="{{url}}" package-title="{{packageTitle}}"></existdb-package-remove-action>
            <existdb-package-install-action
                    id="install"
                    url="{{packageUrl}}"
                    abbrev="{{abbrev}}"
                    type="{{type}}"
                    version="{{version}}"
                    hidden></existdb-package-install-action>

            <paper-icon-button id="info" icon="info" on-click="_showInfo"></paper-icon-button>
        </div>
    </template>

    <script>
        Polymer({

            is: 'repo-app',

            properties: {

                type: {
                    type: String,
                    reflectToAttribute:true
                },
                abbrev:{
                    type: String,
                    reflectToAttribute:true
                },
                version:{
                    type: String,
                    reflectToAttribute:true
                },
                action: {
                    type: String,
                    reflectToAttribute:true
                },
                status: {
                    type: String,
                    reflectToAttribute:true,
                    notify:true,
                    observer: '_handleStatus'
                },
                installed: {
                    type: String
                },
                available: {
                    type: String
                },
                packageUrl: {
                    type:String,
                    reflectToAttribute:true
                },
                packageTitle:{
                    type: String,
                    reflectToAttribute:true,
                    notify:true
                },
                showAll:{
                    type:Boolean,
                    reflectToAttribute:true
                }

//                reflectToAttribute: true
            },

            listeners: {
//                'info.tap': 'handleInfo',
//                'delete.tap': 'handleDelete'
            },

            handleInfo: function (e) {
                e.stopPropagation()
                e.preventDefault()
               var detail = this.querySelector('table');
               console.log(detail)
                if(detail.hasAttribute("class")){
                   detail.removeAttribute("class")
                }else{
                    detail.setAttribute("class","hidden")
                }

            },

            attached: function () {
                console.log("repo-app attached");
                this.setAttribute('tabindex','0');

                this.listen(this, 'tap', '_handleTap')
                this.listen(this, 'keyup', '_handleEnter')
/*
                this.querySelector("a[target='_blank']").addEventListener("click", function (e) {
                    e.preventDefault()
                })
*/
            },

            ready:function () {
                console.log("repo-app title", this.querySelector('repo-title').textContent);
                this.$.remove.packageTitle = this.querySelector('repo-title').textContent;

            },


            handleDelete: function (e) {
                
            },

            _handleTap: function (e) {
                console.log('_handleTap ',e);
                if(e.target.nodeName.toLowerCase() == "repo-app"){
                    this._openApp()
                }
            },

            _handleEnter: function (e) {
                console.log("key ", e)
                if (e.target.nodeName.toLowerCase() == "repo-app" && e.keyCode == 13) {
                    this._openApp()
                }
            },

            _openApp: function () {
                var isApp = this.querySelector("repo-type").textContent == 'application';
                console.log("######## is App: ", isApp);

                if(isApp){
                    var targetUrl = this.url
                    window.open(targetUrl)
                }
/*
                if(this.status == 'installed' && this.type== 'application'){
                    var targetUrl = this.querySelector("repo-url").href
                    window.open(targetUrl)
                }
*/
            },

            _handleStatus: function () {
                console.log("_handleStatus ",this.status);

                if(this.status == 'installed'){
                    this.$.install.hidden = true;
                    this.$.remove.hidden = false;
                }else{
                    this.$.remove.hidden = true;
                    this.$.install.hidden = false;
                }
            },

            _showInfo(e){
                e.stopPropagation();
                e.preventDefault();
                var showsAll = this.$.wrapper.getAttribute('show-all');
                console.log("############### ", showsAll)


                if(!showsAll){
                    this.$.wrapper.setAttribute('show-all','true');
                }else{
                    this.$.wrapper.removeAttribute('show-all');
                }

                console.log("showInfo ",e);
                console.log("repo-app.showInfo");
                console.log("repo-app.showInfo polymer ", Polymer.dom(e));
            }


        });
    </script>
</dom-module>
