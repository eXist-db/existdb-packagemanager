<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="bower_components/iron-pages/iron-pages.html">
<link rel="import" href="bower_components/paper-styles/color.html">
<link rel="import" href="bower_components/paper-styles/typography.html">
<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/iron-icon/iron-icon.html">
<link rel="import" href="bower_components/paper-fab/paper-fab.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="bower_components/bottom-nav/bottom-nav.html">
<link rel="import" href="bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="bower_components/neon-animation/neon-animatable.html">
<link rel="import" href="bower_components/neon-animation/neon-animations.html">
<link rel="import" href="bower_components/paper-toast/paper-toast.html">


<link rel="import" href="existdb-package-descriptor.html">

<!--
`existdb-packagemanager`
a web component implementing eXistdb packagemanager

@demo demo/doc.html
-->

<dom-module id="existdb-packagemanager">
    <template>
        <style>
            :host {
                display: block;

                --paper-tabs-selection-bar-color: var(--paper-blue-700);
                @apply(--paper-font-common-base);
                position: relative;
                background: whitesmoke;
                padding: 0;
                margin: 0;
                width: 100%;
                height: 100%;

                --vaadin-upload-button-add: {
                    background: var(--paper-blue-700);
                }
            }
            app-header-layout app-header.app-header {
                /*border-bottom: 1px solid #dedede;*/
                background: white;
            }

            paper-tabs {
                background: white;
            }

            #packageList {
            }

            ::content ul {
                list-style: none;
                padding: 0;
            }

            ::content #localItemList{
                margin-bottom:100px;
            }
            ::content existdb-package-descriptor {
                background: white;
                margin: 10px 0;
                border: thin solid #dedede;

            }

            ::content ul li table {
                display: none;
            }

            ::content .packageIconArea {
                /*display: inline-flex;*/
            }

            ::content .shortTitle {
                display: flex;
                flex-direction: column;

                flex-grow: 3;
            }

            ::content.appIcon {
                max-width: 100px;
                height: 40px;
            }

            /*
                        paper-fab {
                            position: fixed;
                            z-index: 10;
                            bottom: 20px;
                            right: 20px;
                            --paper-fab-background: var(--paper-blue-700);
                        }
            */
            #packageList {
                margin-bottom: 100px;
            }

            iron-icon {
                margin-right: 10px;
                --iron-icon-fill-color: var(--paper-blue-700);
            }

            bottom-nav {
                background: var(--paper-blue-50);
            }

            app-toolbar {
                z-index: 10;
                background: white;

            }

            /*
                        ::content existdb-package-descriptor[type]:before{
                            font-size:11px;
                            padding: 3px;
                            display: inline;
                        }
                        ::content existdb-package-descriptor[type="application"]:before{
                            content: "Application";
                            color:var(--paper-blue-700);
                        }
                        ::content existdb-package-descriptor[type="library"]:before{
                            content: "Library";
                            color:var(--paper-light-green-700);
                        }
            */

        </style>
        <iron-ajax id="loadInstalled"
                   verbose with-credentials
                   method="get" handle-as="text"
                   on-response="handleLocalItems"
                   url="/exist/apps/packagemanager/packages/?format=manager&type=local"
                   auto></iron-ajax>

<!--
        <iron-ajax id="loadAvailable"
                   verbose with-credentials
                   method="get" handle-as="document"
                   on-response="handleAvailableItems"
                   url="/exist/apps/packagemanager/packages/?format=manager&type=remote"
                   auto></iron-ajax>
-->

        <app-header-layout fullbleed>
            <app-header class="app-header" condenses reveals effects="waterfall" fixed>
                <app-toolbar sticky>
                    <iron-icon icon="apps"></iron-icon>
                    <div>Package Manager</div>
                </app-toolbar>
                <paper-tabs selected="{{selected}}">
                    <!--<paper-tab>All</paper-tab>-->
                    <paper-tab id="installedTab">Installed</paper-tab>
                    <paper-tab id="availableTab">Available</paper-tab>
                </paper-tabs>
            </app-header>

            <neon-animated-pages id="pages" selected="[[selected]]" entry-animation="[[entryAnimation]]"
                                 exit-animation="[[exitAnimation]]">
                <neon-animatable>
                    <div id="localItemList"></div>
                </neon-animatable>
                <neon-animatable>
                    <div id="availableItemList">hello</div>
                </neon-animatable>
            </neon-animated-pages>


            <bottom-nav id="bottom" fixed>
                <vaadin-upload accept=".xar" method="post" target="/exist/apps/packagemanager/modules/install.xql">
                    <div class="drop-label">
                        <iron-icon icon="description"></iron-icon>
                        DROPZONE - put your package(s) here.
                    </div>
                </vaadin-upload>
            </bottom-nav>
        </app-header-layout>
        <paper-toast id="toast" text="" duration="3000"></paper-toast>
    </template>

    <script>
        Polymer({

            is: 'existdb-packagemanager',

            properties: {
                url: String,
                notify: true,
                reflectToAttribute: true
            },
            listeners: {
                'installedTab.tap': 'switchToInstalled',
                'availableTab.tap': 'switchToAvailable'
            },

            attached: function () {
                this.selected = 0;
//                this.$.bottom.threshold = 200;

                this.listen(document, 'package-removed', '_handlePackageRemoved')
                this.listen(document, 'package-remove-error', '_handlePackageRemoveError')
            },

            detached: function () {
                this.unlisten(document, 'package-removed', '_handlePackageRemoved')
                this.unlisten(document, 'package-remove-error', '_handlePackageRemoveError')
            },

            handleLocalItems: function (data) {
                this.$.localItemList.innerHTML = this.$.loadInstalled.lastResponse
            },

            handleAvailableItems: function (data) {
                this.$.availableItemList.innerHTML = this.$.loadAvailable.lastResponse
            },

            showUpload: function (e) {
                this.$.upload.open();
            },

            switchToInstalled: function (e) {
                this.entryAnimation = 'slide-from-left-animation';
                this.exitAnimation = 'slide-right-animation';
                this.$.pages.selected=0;
            },

            switchToAvailable: function (e) {
                this.entryAnimation = 'slide-from-right-animation';
                this.exitAnimation = 'slide-left-animation';
                this.$.pages.selected=1;
            },

            _handlePackageRemoved: function (e) {
                this.$.loadInstalled.generateRequest()
                this.$.toast.text='Package has been removed.'
                this.$.toast.open()
            },
            _handlePackageRemoveError: function (e) {
                this.$.toast.text=e.detail.error
                this.$.toast.duration=-1
                this.$.toast.open()
            }

        });
    </script>
</dom-module>
