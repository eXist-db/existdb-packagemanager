<!--<script src="../../ziziphus-ce/node_modules/bower/lib/node_modules/lodash/_arrayEach.js"></script>-->
<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="bower_components/iron-pages/iron-pages.html">
<link rel="import" href="bower_components/paper-styles/color.html">
<link rel="import" href="bower_components/paper-styles/typography.html">
<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/iron-icons/image-icons.html">
<link rel="import" href="bower_components/iron-icon/iron-icon.html">
<link rel="import" href="bower_components/paper-fab/paper-fab.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="bower_components/bottom-nav/bottom-nav.html">
<link rel="import" href="bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="bower_components/neon-animation/web-animations.html">
<link rel="import" href="bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="bower_components/neon-animation/neon-animatable.html">
<link rel="import" href="bower_components/neon-animation/neon-animations.html">
<link rel="import" href="bower_components/neon-animation/neon-animatable-behavior.html">
<link rel="import" href="bower_components/neon-animation/neon-shared-element-animatable-behavior.html">
<link rel="import" href="bower_components/neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="bower_components/neon-animation/animations/slide-from-right-animation.html">
<link rel="import" href="bower_components/paper-toast/paper-toast.html">
<link rel="import" href="bower_components/paper-progress/paper-progress.html">
<link rel="import" href="bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="bower_components/paper-input/paper-input.html">
<link rel="import" href="bower_components/paper-fab/paper-fab.html">
<link rel="import" href="bower_components/paper-item/paper-item.html">
<link rel="import" href="bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="bower_components/paper-menu-button/paper-menu-button.html">

<link rel="import" href="existdb-packages.html">
<link rel="import" href="existdb-package-descriptor.html">
<link rel="import" href="repo-app.html">
<link rel="import" href="repo-icon.html">

<!--
`existdb-packagemanager`
a web component implementing eXistdb packagemanager

@demo demo/doc.html
-->

<dom-module id="existdb-packagemanager">
    <template>
        <style>
            :host {
                display: block;

                --paper-tabs-selection-bar-color: var(--paper-blue-700);
                @apply(--paper-font-common-base);
                position: relative;
                background: whitesmoke;
                padding: 0;
                margin: 0;
                --vaadin-upload-button-add: {
                    background: var(--paper-blue-700);
                };

                --paper-toggle-button-checked-button-color: var(--paper-blue-700);

                --app-header-background-front-layer: {
                    background: var(--paper-blue-500);

                };
            }

            app-header-layout app-header.app-header {
                /*border-bottom: 1px solid #dedede;*/
            }

            app-header {
                background: var(--paper-blue-500);
            }

            #search {
                display: inline-block;
                font-size: 12px;
                margin-right:20px;
            }
            #filterRepo{
                margin-right:40px;
            }

            iron-icon {
                margin-right: 10px;
                --iron-icon-fill-color: var(--paper-blue-700);
            }

            app-toolbar {
                z-index: 10;
                background: white;

            }

            #uploader {
                background: var(--paper-blue-50);
            }

            #uploader .drop-label {
                color: var(--paper-blue-900);
            }

            #toast {
                --paper-toast-background-color: var(--paper-blue-700);
                --paper-toast-color: white;
            }

            #toastError {
                --paper-toast-background-color: var(--paper-red-700);
                --paper-toast-color: white;
            }

            ::content .upgrade {
                color: var(--paper-red-700);
            }

            paper-input[type='search'] {
                width: 140px;
            }

            ::slotted(repo-title) {
                font-size: 28px;
                font-weight: 500;
            }

            /*
                        ::slotted(repo-name),
                        ::slotted(repo-description),
                        ::slotted(repo-author),
                        ::slotted(repo-abbrev),
                        ::slotted(repo-license),
                        ::slotted(repo-website),
                        ::slotted(repo-url)
                        {
                            display: none;
                        }

            */
            paper-fab {
                position: fixed;
                right: 45px;
                bottom: 40px;
                z-index: 100;
                --paper-fab-background: var(--paper-pink-500);
                --iron-icon-fill-color: var(--paper-grey-50);
            }

            .heading {
                display: none;
            }

            @media only screen and (min-width: 768px) {
                .heading {
                    width: 100%;
                    display: inline-block;
                    font-weight: 300;
                    text-align: center;
                    flex-grow: 2;
                    color: var(--paper-grey-500);
                }
            }

            .repo-toolbar {
                position: fixed;
                height: 64px;
                width: 100%;
            }

            .repo-toolbar {
                box-shadow: -1px 6px 6px -3px rgba(0, 0, 0, 0.4);
            }

            #remoteService {
                padding-top: 65px;
            }
        </style>

        <neon-animated-pages id="pages" nolibs="true" selected="{{selected}}" entry-animation="[[entryAnimation]]"
                             exit-animation="[[exitAnimation]]">

            <neon-animatable id="localPage">
                <app-header-layout fullbleed>
                    <app-header slot="header" class="app-header" condenses reveals effects="waterfall" fixed>
                        <app-toolbar sticky>
                            <iron-icon icon="apps"></iron-icon>
                            <div main-title>PackageManager</div>
                            <span class="heading">Installed packages {{localCount}}</span>

                            <paper-input id="search" class="searchbox" type="search" name="query" value="{{filter}}"
                                         label="filter..." no-label-float auto-focus>
                                <iron-icon icon="filter-list" slot="suffix"></iron-icon>
                            </paper-input>

                            <paper-menu-button id="moreMenu" close-on-activate horizontal-align="right">
                                <paper-icon-button icon="more-vert" mini slot="dropdown-trigger"></paper-icon-button>
                                <paper-listbox slot="dropdown-content">
                                    <paper-item id="libSwitch" on-click="_showLibraries">show libraries</paper-item>
                                    <paper-item>logout</paper-item>
                                </paper-listbox>
                            </paper-menu-button>

                        </app-toolbar>
                        <vaadin-upload id="uploader" accept=".xar" method="post" target="{{targetUrl}}">
                            <div class="drop-label">
                                <iron-icon icon="image:adjust"></iron-icon>
                                DROPZONE - put your package(s) here.
                            </div>
                        </vaadin-upload>

                    </app-header>
                    <existdb-packages id="localService"
                                      service="/exist/apps/existdb-packageservice/packages/apps"></existdb-packages>
                    <paper-fab icon="add" on-click="switchToAvailable"></paper-fab>
                </app-header-layout>
            </neon-animatable>

            <neon-animatable id="repoPage">

                <app-toolbar class="repo-toolbar">
                    <paper-icon-button icon="chevron-left" on-click="_switchToInstalled"></paper-icon-button>
                    <div class="heading">Available Packages {{remoteCount}}</div>

                    <paper-input id="filterRepo" class="searchbox" type="search" name="query" value="{{filter}}"
                                 label="filter..." no-label-float auto-focus>
                        <iron-icon icon="filter-list" slot="suffix"></iron-icon>
                    </paper-input>

                </app-toolbar>
                <existdb-packages id="remoteService"
                                  service="/exist/apps/existdb-packageservice/packages/remote"></existdb-packages>
            </neon-animatable>

        </neon-animated-pages>
        <paper-toast id="toast" text="" duration="4000"></paper-toast>
        <paper-toast id="toastError" text="" duration="-1">
            <paper-icon-button icon="clear" on-click="_hideToast"></paper-icon-button>
        </paper-toast>
    </template>

    <script>
        Polymer({

            is: 'existdb-packagemanager',

            behaviors: [
                Polymer.NeonAnimationBehavior,
                Polymer.NeonAnimationRunnerBehavior
            ],

            properties: {
                url: {
                    type: String,
                    notify: true,
                    reflectToAttribute: true
                },
                targetUrl: {
                    type: String,
                },
                /*
                                animationConfig: {
                                    value: function () {
                                        return {
                                            // provided by neon-animation/animations/scale-down-animation.html
                                            name: 'scale-down-animation',
                                            node: this.$.uploader
                                        }
                                    }
                                },
                */
                filter: {
                    type: String,
                    notify: true,
                    reflectToAttribute: true,
                    observer: '_handleFilter'
                },
                lastInstalled: {
                    type: String
                },
                localCount: {
                    type: Number
                },
                remoteCount: {
                    type: Number
                },
                selected: {
                    observer: '_handlePageChange',
                    value: 0
                }

            },
            listeners: {
                'neon-animation-finish': '_onNeonAnimationFinish'
            },

            attached: function () {
                this.timeout = 0;
                this.selected = 0;
                this.listen(document, 'package-removed', '_handlePackageRemoved');
                this.listen(document, 'package-remove-error', '_handlePackageRemoveError');
                this.listen(document, 'package-installed', '_handlePackageInstalled');
                this.listen(document, 'package-install-error', '_handlePackageInstallError');
                this.listen(document, 'packagemanager-remove-attempt', '_handleRemoveAttempt');
                this.listen(this.$.localService, 'packages-loaded', '_handlePackagesLoaded');
                this.listen(this.$.remoteService, 'packages-loaded', '_handlePackagesLoaded');
                this.targetUrl = "/exist/apps/packagemanager/modules/install.xql";
                this.$.uploader.formDataName = "uploadedfiles[]";

                this.$.uploader.addEventListener('upload-before', function (event) {
                    console.log('upload xhr before open: ', event.detail.xhr);
                    var file = event.detail.file;
                    file.uploadTarget = '/exist/apps/existdb-packageservice/modules/install.xql?name=' + file.name;
                });
                this.$.uploader.addEventListener('upload-progress', function (event) {
                    console.log('upload progress: ', event.detail.file);
                    var file = event.detail.file;
                });

                var that = this;
                this.$.uploader.addEventListener('upload-success', function (e) {
                    console.log("onuploadsuccess", e)
                    var file = e.detail.file
                    var self = this
                    that.$.localService.loadPackages();

                    setTimeout(function () {
                        self.splice('files', self.files.indexOf(file), 1);
                    }, 1000)

                });
                this.$.uploader.addEventListener('upload-error', function (e) {
                    console.log("Upload error: ", e.detail)
                    this._toastError("Upload failed for: " + e.detail.file)
                });

                var self = this;
                this.addEventListener('keyup', function (e) {
                    console.log("kepup", this);
                    if (e.keyCode == 27) {
                        console.log("ESC")
                        self._resetFilters();
                        self.focus();
                    }
                    /*
                                        if (e.keyCode == 65) {
                                            this.$.pages.selected=1;
                                        }
                                        if (e.keyCode == 66) {
                                            this.$.pages.selected=0;
                                        }
                                        if (e.keyCode == 70) {
                                            this.$.search.focus();
                                        }
                                        if (e.keyCode == 76) {
                                            this._showLibraries(e);
                                        }
                                        if (e.keyCode == 85) {
                                            this.querySelector('#addFiles').click();
                                        }
                                        self.filter(e)
                    */
                });

                /*
                                this.$.search.addEventListener('keyup', function (e) {
                                    this.filter(e);
                                });
                */

                this._switchToInstalled()
                this.$.search.focus()
            },

            detached: function () {
                this.unlisten(document, 'package-removed', '_handlePackageRemoved');
                this.unlisten(document, 'package-remove-error', '_handlePackageRemoveError');
                this.unlisten(document, 'package-installed', '_handlePackageInstalled');
                this.unlisten(document, 'package-install-error', '_handlePackageInstallError');
                this.unlisten(document, 'packagemanager-remove-attempt', '_handleRemoveAttempt');
                this.unlisten(this.$.localService, 'packages-loaded', '_handlePackagesLoaded');
                this.unlisten(this.$.remoteService, 'packages-loaded', '_handlePackagesLoaded');

            },

/*
            filterPackages: function (e) {
                this.debounce('filter', 'this._handleSearchInput', 500);
            },
*/
            _handlePackagesLoaded: function (e) {
                console.log('################# _handlePackagesLoaded', e);
                console.log('_handlePackagesLoaded lastInstalled', this.lastInstalled);

                this.local = [];
                this.remote = [];
                this.local = this.$.localPage.querySelectorAll('repo-app');
                this.localCount = this.local.length;

                console.log('_handlePackagesLoaded local', this.local);
                console.log('_handlePackagesLoaded remote', this.remote);

                if (this.lastInstalled == 'libraries') {
                    this.lastInstalled = this.querySelectorAll('repo-app[type="library"]')[0];
                    console.log("last lib ", this.lastInstalled);
                    this._scrollAndFocus(this.lastInstalled);
                    return;
                }

                this.remote = this.$.repoPage.querySelectorAll('repo-app');
                this.remoteCount = this.remote.length;
                if (this.lastInstalled) {
                    for (i = 0; i < this.local.length; ++i) {
                        var app = this.local[i]
                        var url = app.url;
                        if (url == this.lastInstalled) {
                            console.log("scroll top ", app);
                            this._scrollAndFocus(app);
                            this.lastInstalled = undefined;
                        }
                    }
                }

            },

            _scrollAndFocus: function (app) {
                app.scrollIntoView();
                window.scrollBy(0, -130)
                app.focus();
            },

            _handlePageChange: function (newValue, oldValue) {
                console.log('_handlePageChange ', newValue, oldValue);

                if (newValue == 0) {
                    //local page
                    this.focus();
                    this.entryAnimation = 'slide-from-left-animation';
                    this.exitAnimation = 'slide-right-animation';
                    this.$.localService.loadPackages();
                } else {
                    //repo page
                    this.$.repoPage.focus();
                    this.entryAnimation = 'slide-from-right-animation';
                    this.exitAnimation = 'slide-left-animation';
                    this.$.remoteService.loadPackages();
                }
            },


            _handleFilter: function (e) {
                console.log('_handleFilter - filter string has changed ', e);
                console.log('_handleFilter - filter string has changed this', this);
                this._handleSearchInput(e);
            },


            _handleSearchInput: function (e) {
                console.log('_handleSearchInput', e);

                var apps, filterString;
                if(this.selected == 0){
                    if (this.$.search.value == undefined) return;
                    apps = this.local;
                    filterString = this.$.search.value.toLowerCase();
                }else{
                    apps = this.remote;
                    filterString = this.$.filterRepo.value.toLowerCase();
                }

                for (i = 0; i < apps.length; ++i) {
                    var app = apps[i]
                    var shortTitle = app.querySelector("repo-title").textContent;

                    if (!shortTitle.toLowerCase().startsWith(filterString)) {
                        app.setAttribute('hidden', '')
                    } else if (app.hasAttribute('hidden')) {
                        app.removeAttribute('hidden')
                    }
                }
                var hiddenItems = this.querySelectorAll("repo-app[hidden]")
                if (hiddenItems.length == apps.length - 1) {
                    var found = this.querySelector("repo-app:not([hidden])")
                    found.focus()
                }
            },

            _resetFilters:function () {
                this.$.search.value='';
                this.$.filterRepo.value='';
            },

            showUpload: function (e) {
                this.$.upload.open();
            },

            _switchToInstalled: function (e) {
                this.$.pages.selected = 0;
            },

            switchToAvailable: function (e) {
                this.$.pages.selected = 1;
            },

            _handlePackageRemoved: function (e) {
                this.$.localService.loadPackages();
                this._toast('Package has been removed: ' + e.detail.package)
            },

            _handlePackageRemoveError: function (e) {
                this._toastError(e.detail.error.error.message)
            },

            _handlePackageInstalled: function (e) {
                this._toast('Package has been installed: ' + e.detail.package)
                this.$.localService.loadPackages();
                this.$.pages.selected = 0;
                this.lastInstalled = e.detail.package;
            },

            _handlePackageInstallError: function (e) {
                this._toastError(e.detail.error.error.message)
            },

            _toast: function (msg) {
                this.$.toast.text = msg
                this.$.toast.open()
            },
            _toastError: function (msg) {
                this.$.toastError.text = msg
                this.$.toastError.open()
            },

            _onNeonAnimationFinish: function () {
                console.log('animation done!');
            },

            _hideToast: function (e) {
                this.$.toastError.hide()
            },

            _handleRemoveAttempt: function (e) {
                this._toastError("Package Manager cannot be removed.")
            },

            _showLibraries: function (e) {
                this._resetFilters();

                if (this.$.libSwitch.innerText == 'show libraries') {
                    this.$.localService.service = "/exist/apps/existdb-packageservice/packages/local";
                    this.$.localService.loadPackages();
                    this.lastInstalled = 'libraries';
                    this.$.libSwitch.innerText = "hide libraries";
                } else {
                    this.$.localService.service = "/exist/apps/existdb-packageservice/packages/apps";
                    this.$.localService.loadPackages();
                    this.lastInstalled = undefined;
                    this.$.libSwitch.innerText = "show libraries";
                    var firstApp = this.$.localService.querySelectorAll('repo-app[type="application"]')[0];
                    this._scrollAndFocus(firstApp);
                }
                console.log('_showLibraries ', this.lastInstalled);
            }


            /*
             _onUploadProgress: function (e) {
             console.log("onprogress ", e.detail.file.progress)
             this.$.progress.value = e.detail.file.progress
             }
             */





        });
    </script>
</dom-module>
