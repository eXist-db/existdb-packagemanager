<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="bower_components/iron-pages/iron-pages.html">
<link rel="import" href="bower_components/paper-styles/color.html">
<link rel="import" href="bower_components/paper-styles/typography.html">
<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/iron-icons/image-icons.html">
<link rel="import" href="bower_components/iron-icon/iron-icon.html">
<link rel="import" href="bower_components/paper-fab/paper-fab.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="bower_components/bottom-nav/bottom-nav.html">
<link rel="import" href="bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="bower_components/neon-animation/neon-animatable.html">
<link rel="import" href="bower_components/neon-animation/neon-animations.html">
<link rel="import" href="bower_components/neon-animation/neon-shared-element-animatable-behavior.html">
<link rel="import" href="bower_components/neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="bower_components/paper-toast/paper-toast.html">
<link rel="import" href="bower_components/paper-progress/paper-progress.html">
<link rel="import" href="bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="bower_components/paper-input/paper-input.html">

<link rel="import" href="existdb-package-descriptor.html">

<!--
`existdb-packagemanager`
a web component implementing eXistdb packagemanager

@demo demo/doc.html
-->

<dom-module id="existdb-packagemanager">
    <template>
        <style>
            :host {
                display: block;

                --paper-tabs-selection-bar-color: var(--paper-blue-700);
                @apply(--paper-font-common-base);
                position: relative;
                background: whitesmoke;
                padding: 0;
                margin: 0;
                width: 100%;
                height: 100%;

                --vaadin-upload-button-add: {
                    background: var(--paper-blue-700);
                };

                --paper-toggle-button-checked-button-color:var(--paper-blue-700);
            }

            app-header-layout app-header.app-header {
                /*border-bottom: 1px solid #dedede;*/
                background: white;
            }

            paper-tabs {
                background: white;
                max-width: 50%;
            }

            #packageList {
            }

            ::content ul {
                list-style: none;
                padding: 0;
            }

            ::content #localItemList {
                margin-bottom: 100px;
            }

            ::content existdb-package-descriptor {
                background: white;
                margin: 10px 0;
                border: thin solid #dedede;

            }

            ::content ul li table {
                display: none;
            }

            ::content .packageIconArea {
                /*display: inline-flex;*/
            }

            ::content .wrapper {
                /*display: flex;*/
            }

            ::content .shortTitle {
                /*display: flex;*/
                /*flex-direction: column;*/
                /*flex-grow: 3;*/
            }

            ::content.appIcon {
                max-width: 100px;
                height: 40px;
            }

            #packageList {
                margin-bottom: 100px;
            }

            iron-icon {
                margin-right: 10px;
                --iron-icon-fill-color: var(--paper-blue-700);
            }

            bottom-nav {
                background: var(--paper-blue-50);
            }

            app-toolbar {
                z-index: 10;
                background: white;

            }

            .paper-progress {
                width: 100%;
                display: block;
                margin-top: -2px;

                --paper-progress-active-color: var(--paper-blue-500);
                --paper-progress-height: 2px;
            }

            #toast {
                --paper-toast-background-color: var(--paper-blue-700);
                --paper-toast-color: white;
            }

            #toastError {
                --paper-toast-background-color: var(--paper-red-700);
                --paper-toast-color: white;
            }

            paper-toggle-button{
                font-size:12px;
                position: absolute;
                top:76px;
                right:20px;
            }
            [nolibs='true'] ::content existdb-package-descriptor[type='library']{
                display: none;
            }
            [nolibs='false'] ::content existdb-package-descriptor[type='library']{
                display: block;
            }
            ::content .upgrade{
                color:var(--paper-red-700);
            }

            paper-input[type='search']{
                width:140px;
            }
        </style>
        <iron-ajax id="loadInstalled"
                   verbose with-credentials
                   method="get" handle-as="text"
                   on-response="handleLocalItems"
                   url="/exist/apps/packagemanager/packages/?&format=manager&type=local"
                   on-error="_handleLocalError"></iron-ajax>

        <iron-ajax id="loadAvailable"
                   verbose with-credentials
                   method="get" handle-as="text"
                   on-response="handleAvailableItems"
                   headers='{"host": location.host}'
                   url="/exist/apps/packagemanager/packages/?format=manager&type=remote"
                   on-error="_handleLoadAvailableError"></iron-ajax>

        <app-header-layout fullbleed>
            <app-header class="app-header" condenses reveals effects="waterfall" fixed>
                <app-toolbar sticky>
                    <iron-icon icon="apps"></iron-icon>
                    <div main-title>Package Manager</div>
                    <paper-input id="search" type="search" no-label-float tabindex="0" on-keyup="_handleSearchInput">
                        <iron-icon icon="search" prefix></iron-icon>
                        <!--<iron-icon icon="clear" suffix></iron-icon>-->
                    </paper-input>
                    <paper-toggle-button id="libToggle">show libraries</paper-toggle-button>
                </app-toolbar>
                <paper-tabs selected="{{selected}}">
                    <paper-tab id="installedTab">Installed</paper-tab>
                    <paper-tab id="availableTab">Available</paper-tab>
                </paper-tabs>
                <paper-progress id="progress" class="paper-progress" value="" hidden></paper-progress>

            </app-header>
            <neon-animated-pages id="pages" nolibs="true" selected="[[selected]]" entry-animation="[[entryAnimation]]"
                                 exit-animation="[[exitAnimation]]">
                <neon-animatable>
                    <div id="localItemList"></div>
                </neon-animatable>
                <neon-animatable>
                    <div id="availableItemList"></div>
                </neon-animatable>
            </neon-animated-pages>


            <bottom-nav id="bottom">

                <vaadin-upload id="uploader" accept=".xar" method="post" target="{{targetUrl}}">
                    <div class="drop-label">
                        <iron-icon icon="image:adjust"></iron-icon>
                        DROPZONE - put your package(s) here.
                    </div>
                </vaadin-upload>
            </bottom-nav>
        </app-header-layout>
        <paper-toast id="toast" text="" duration="4000"></paper-toast>
        <paper-toast id="toastError" text="" duration="-1">
            <paper-icon-button icon="clear" on-click="_hideToast"></paper-icon-button>
        </paper-toast>
    </template>

    <script>
        Polymer({

            is: 'existdb-packagemanager',

            behaviors: [
                Polymer.NeonAnimationBehavior,
                Polymer.NeonAnimationRunnerBehavior
            ],

            properties: {
                url: {
                    type: String,
                    notify: true,
                    reflectToAttribute: true
                },
                targetUrl: {
                    type: String,
                },
                animationConfig: {
                    value: function () {
                        return {
                            // provided by neon-animation/animations/scale-down-animation.html
                            name: 'scale-down-animation',
                            node: this.$.uploader
                        }
                    }
                },
            },
            listeners: {
                'installedTab.tap': 'switchToInstalled',
                'availableTab.tap': 'switchToAvailable',
                'neon-animation-finish': '_onNeonAnimationFinish',
                'libToggle.tap': '_onLibToggle'
            },

            attached: function () {
                this.selected = 0;
                this.listen(document, 'package-removed', '_handlePackageRemoved')
                this.listen(document, 'package-remove-error', '_handlePackageRemoveError')
                this.listen(document, 'package-installed', '_handlePackageInstalled')
                this.listen(document, 'package-install-error', '_handlePackageInstallError')
                this.listen(document, 'packagemanager-remove-attempt', '_handleRemoveAttempt')
                this.targetUrl = "/exist/apps/packagemanager/modules/install.xql"
                this.$.uploader.formDataName = "uploadedfiles[]"

                this.$.uploader.addEventListener('upload-before', function (event) {
                    console.log('upload xhr before open: ', event.detail.xhr);
                    var file = event.detail.file;
                    file.uploadTarget = '/exist/apps/packagemanager/modules/install.xql?name=' + file.name;
                });
                this.$.uploader.addEventListener('upload-progress', function (event) {
                    console.log('upload progress: ', event.detail.file);
                    var file = event.detail.file;
                });

                var that = this
                this.$.uploader.addEventListener('upload-success', function (e) {
                    console.log("onuploadsuccess", e)
                    var file = e.detail.file
                    var self = this
                    that.$.loadInstalled.generateRequest()
                    setTimeout(function () {
                        self.splice('files', self.files.indexOf(file), 1);
                    }, 1000)

                });
                this.$.uploader.addEventListener('upload-error', function (e) {
                    console.log("Upload error: ", e.detail)
                    this._toastError("Upload failed for: " + e.detail.file)
                });

                this.addEventListener('keyup',function(e){
                    if(e.keyCode == 27){
                        console.log("ESC")
                        this.$.search.value=""
                        this._handleSearchInput(e)
                        this.$.search.focus()
                    }
                })

                this.switchToInstalled()
                this.$.search.focus()
            },

            detached: function () {
                this.unlisten(document, 'package-removed', '_handlePackageRemoved')
                this.unlisten(document, 'package-remove-error', '_handlePackageRemoveError')
                this.unlisten(document, 'package-installed', '_handlePackageInstalled')
                this.unlisten(document, 'package-install-error', '_handlePackageInstallError')
                this.unlisten(document, 'packagemanager-remove-attempt', '_handleRemoveAttempt')
            },

            _handleSearchInput: function (e) {
                console.log("search input: ", e.detail, this.$.search.value)
                var s = this.$.search.value.toLowerCase()
                var descriptors = this.querySelectorAll('existdb-package-descriptor')
                console.log(descriptors)

                for (i = 0; i < descriptors.length; ++i) {
                    var descriptor = descriptors[i]

                    if(!descriptor.getAttribute('abbrev').toLowerCase().startsWith(s) && !descriptor.getAttribute('short-title').toLowerCase().startsWith(s)){
                        descriptor.setAttribute('hidden','')
                    }else if(descriptor.hasAttribute('hidden')){
                        descriptor.removeAttribute('hidden')
                    }
                }
                var hiddenItems = this.querySelectorAll("existdb-package-descriptor[hidden]")
                if(hiddenItems.length ==  descriptors.length -1){
                    var found = this.querySelector("existdb-package-descriptor:not([hidden])")
                    console.log("only one left", found)
                    found.focus()
                }
            },

            handleLocalItems: function (data) {
                this.$.localItemList.innerHTML = this.$.loadInstalled.lastResponse
                this.$.pages.selected = 0;
                this._resetProgress()
            },

            handleAvailableItems: function (data) {
                this.$.availableItemList.innerHTML = this.$.loadAvailable.lastResponse
                this.$.pages.selected = 1;
                this._resetProgress()
            },

            _resetProgress:function () {
                this.$.progress.value = 100
                var self = this;
                setTimeout(function () {
                    self.$.progress.value = 0
                    self.$.progress.indeterminate = false
                }, 1000)

                this.$.progress.hidden=true
            },

            showUpload: function (e) {
                this.$.upload.open();
            },


            switchToInstalled: function (e) {
                this.entryAnimation = 'slide-from-left-animation';
                this.exitAnimation = 'slide-right-animation';
//                this.$.pages.selected = 0;
                this.$.progress.indeterminate = true
                this.$.progress.hidden=false
                this.$.loadInstalled.generateRequest();
            },

            switchToAvailable: function (e) {
                this.entryAnimation = 'slide-from-right-animation';
                this.exitAnimation = 'slide-left-animation';
//                this.$.pages.selected = 1;
                console.log("location: ", location.host)
                this.$.progress.indeterminate = true
                this.$.progress.hidden=false
                this.$.loadAvailable.generateRequest();

            },

            _handlePackageRemoved: function (e) {
                this.$.loadInstalled.generateRequest()
                this._toast('Package has been removed: ' + e.detail.package)
            },

            _handlePackageRemoveError: function (e) {
                this._toastError(e.detail.error.error.message)
            },

            _handlePackageInstalled: function (e) {
                this._toast('Package has been installed: ' + e.detail.package)
                this.$.loadInstalled.generateRequest()
                this.selected = 0

            },
            _handlePackageInstallError: function (e) {
                this._toastError(e.detail.error.error.message)
            },

            _toast: function (msg) {
                this.$.toast.text = msg
                this.$.toast.open()
            },
            _toastError: function (msg) {
                this.$.toastError.text = msg
                this.$.toastError.open()
            },

            _onNeonAnimationFinish: function () {
                console.log('animation done!');
            },

            _handleLocalError:function (e) {
                console.log("loading of available packages failed", e.detail.error)
                this._resetAndHideProgress()
                this._toastError('loading of available packages failed')
            },

            _handleLoadAvailableError: function (e) {
                console.log("loading of available packages failed", e.detail.error)
                this._resetAndHideProgress()
                this._toastError('loading of available packages failed')
            },

            _resetAndHideProgress: function () {
                this.$.progress.indeterminate = false;
                this.$.progress.value = 0;
                this.$.progress.hidden=true
            },

            _hideToast: function (e) {
                this.$.toastError.hide()
            },

            _onLibToggle: function (e) {
                var pages = this.$.pages
                console.log(pages)
                if(pages.getAttribute('nolibs') == 'true'){
                    pages.setAttribute('nolibs','false')
                }else{
                    pages.setAttribute('nolibs','true')
                }
            },

            _handleRemoveAttempt: function (e) {
                this._toastError("Package Manager cannot be removed.")
            }



            /*
             _onUploadProgress: function (e) {
             console.log("onprogress ", e.detail.file.progress)
             this.$.progress.value = e.detail.file.progress
             }
             */


        });
    </script>
</dom-module>
