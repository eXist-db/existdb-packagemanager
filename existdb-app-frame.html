<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="bower_components/iron-pages/iron-pages.html">
<link rel="import" href="bower_components/paper-styles/color.html">
<link rel="import" href="bower_components/paper-styles/typography.html">
<link rel="import" href="bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/iron-icons/image-icons.html">
<link rel="import" href="bower_components/iron-icon/iron-icon.html">
<link rel="import" href="bower_components/paper-fab/paper-fab.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="bower_components/bottom-nav/bottom-nav.html">
<link rel="import" href="bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="bower_components/neon-animation/neon-animatable.html">
<link rel="import" href="bower_components/neon-animation/neon-animations.html">
<link rel="import" href="bower_components/neon-animation/neon-shared-element-animatable-behavior.html">
<link rel="import" href="bower_components/neon-animation/neon-animation-runner-behavior.html">
<link rel="import" href="bower_components/paper-toast/paper-toast.html">
<link rel="import" href="bower_components/paper-progress/paper-progress.html">
<link rel="import" href="bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="bower_components/paper-item/paper-item.html">
<link rel="import" href="bower_components/paper-menu/paper-menu.html">


<link rel="import" href="existdb-package-descriptor.html">

<!--
`existdb-packagemanager`
a web component implementing eXistdb packagemanager

@demo demo/doc.html
-->

<dom-module id="existdb-packagemanager">
    <template>
        <style>
            :host {
                display: block;

                --paper-tabs-selection-bar-color: var(--paper-blue-700);
                @apply(--paper-font-common-base);
                position: relative;
                background: whitesmoke;
                padding: 0;
                margin: 0;
                width: 100%;
                height: 100%;

                --vaadin-upload-button-add: {
                    background: var(--paper-blue-700);
                };
            }

            app-header-layout app-header.app-header {
                /*border-bottom: 1px solid #dedede;*/
                background: white;
            }

            paper-tabs {
                background: white;
            }

            #packageList {
            }

            ::content ul {
                list-style: none;
                padding: 0;
            }

            ::content #localItemList {
                margin-bottom: 100px;
            }

            ::content existdb-package-descriptor {
                background: white;
                margin: 10px 0;
                border: thin solid #dedede;

            }

            ::content ul li table {
                display: none;
            }

            ::content .packageIconArea {
                /*display: inline-flex;*/
            }

            ::content .wrapper {
                /*display: flex;*/
            }

            ::content .shortTitle {
                /*display: flex;*/
                /*flex-direction: column;*/
                /*flex-grow: 3;*/
            }

            ::content.appIcon {
                max-width: 100px;
                height: 40px;
            }

            #packageList {
                margin-bottom: 100px;
            }

            iron-icon {
                margin-right: 10px;
                --iron-icon-fill-color: var(--paper-blue-700);
            }

            bottom-nav {
                background: var(--paper-blue-50);
            }

            app-toolbar {
                z-index: 10;
                background: white;

            }

            .paper-progress {
                width: 50%;
                /*float: right;*/
                display: block;
                margin-top: -2px;

                --paper-progress-active-color: var(--paper-green-700);
                --paper-progress-height: 2px;
            }
            #rightprogress{
                float:right;
            }

            #toast {
                --paper-toast-background-color: var(--paper-blue-700);
                --paper-toast-color: white;
            }

            #toastError {
                --paper-toast-background-color: var(--paper-red-700);
                --paper-toast-color: white;
            }

            paper-toggle-button{
                font-size:12px;
                float:right;
            }
            [nolibs='true'] ::content existdb-package-descriptor[type='library']{
                display: none;
            }
            [nolibs='false'] ::content existdb-package-descriptor[type='library']{
                display: block;
            }
            ::content .upgrade{
                color:var(--paper-red-700);
            }


            [grid]{
                display: flex;
                flex-direction: row;
                flex-wrap: wrap;
                margin:0 50px;
            }
            [grid] ::content existdb-package-descriptor{
                width:150px;
                height:150px;
                margin:10px;
                box-shadow: 0 3px 4px 0 rgba(0, 0, 0, 0.14),
                0 1px 8px 0 rgba(0, 0, 0, 0.12),
                0 3px 3px -2px rgba(0, 0, 0, 0.4);

            }
            [grid] ::content existdb-package-descriptor .wrapper{
                display: inline-flex;
                flex-direction: column;
                justify-content: space-between;
            }


            [grid] ::content existdb-package-descriptor .packageIconArea{
                margin-top:15px;
            }

            [grid] ::content existdb-package-descriptor iron-icon{
                width:16px;
                height: 16px;
                position: absolute;
                right: 0;
                top:0;
            }
            [grid] ::content existdb-package-descriptor .type{
                font-size:10px;
                left:10px;
                top: 0;
            }

            [grid] ::content .shortTitle{
                margin:0;
                padding-top: 0;
                padding-bottom: 0;
            }

            [grid] ::content h3{
                font-size: 14px;
                margin:0;
            }
            [grid] ::content .shortTitle p{
                font-size: 12px;
            }
            [grid] ::content .appFunctions{
                right:22px;
            }
            [grid] ::content .wrapper paper-ripple{
                width: 20px;
                height: 20px;
            }
            #login{
                background: var(--paper-blue-700);
                color:white;
                font-size: 14px;
            }
        </style>
        <iron-ajax id="loadInstalled"
                   verbose with-credentials
                   method="get" handle-as="text"
                   on-response="handleLocalItems"
                   url="/exist/apps/packagemanager/packages/?&format=manager&type=local"
                   on-error="_handleLocalError"></iron-ajax>

        <iron-ajax id="loadAvailable"
                   verbose with-credentials
                   method="get" handle-as="text"
                   on-response="handleAvailableItems"
                   headers='{"host": location.host}'
                   url="/exist/apps/packagemanager/packages/?format=manager&type=remote"
                   on-error="_handleLoadAvailableError"></iron-ajax>

        <app-header-layout fullbleed>
            <app-header class="app-header" condenses reveals effects="waterfall" fixed>
                <app-toolbar sticky>
                    <iron-icon icon="apps" on-tap="_switchGrid"></iron-icon>
                    <div main-title>Dashboard</div>


                    <paper-toggle-button id="libToggle">show libraries</paper-toggle-button>


                    <paper-menu-button horizontal-align="right">
                        <paper-icon-button icon="settings" class="dropdown-trigger"></paper-icon-button>
                        <paper-menu class="dropdown-content">
                            <paper-item>User Manager</paper-item>
                            <paper-item>another</paper-item>
                        </paper-menu>
                    </paper-menu-button>
                    <paper-button id="login">Login</paper-button>
                </app-toolbar>
                <paper-tabs selected="{{selected}}">
                    <paper-tab id="installedTab">Installed</paper-tab>
                    <paper-tab id="availableTab">Available</paper-tab>
                </paper-tabs>
                <paper-progress id="leftprogress" class="paper-progress" value="" hidden></paper-progress>
                <paper-progress id="rightprogress" class="paper-progress" value="" hidden></paper-progress>

            </app-header>
            <neon-animated-pages id="pages" nolibs="true" selected="[[selected]]" entry-animation="[[entryAnimation]]"
                                 exit-animation="[[exitAnimation]]">
                <neon-animatable>
                    <div id="localItemList" grid></div>
                </neon-animatable>
                <neon-animatable>
                    <div id="availableItemList"></div>
                </neon-animatable>
            </neon-animated-pages>


            <bottom-nav id="bottom">

                <vaadin-upload id="uploader" accept=".xar" method="post" target="{{targetUrl}}">
                    <div class="drop-label">
                        <iron-icon icon="image:adjust"></iron-icon>
                        DROPZONE - put your package(s) here.
                    </div>
                </vaadin-upload>
            </bottom-nav>
        </app-header-layout>
        <paper-toast id="toast" text="" duration="4000"></paper-toast>
        <paper-toast id="toastError" text="" duration="-1">
            <paper-icon-button icon="clear" on-click="_hideToast"></paper-icon-button>
        </paper-toast>
    </template>

    <script>
        Polymer({

            is: 'existdb-packagemanager',

            behaviors: [
                Polymer.NeonAnimationBehavior,
                Polymer.NeonAnimationRunnerBehavior
            ],

            properties: {
                url: {
                    type: String,
                    notify: true,
                    reflectToAttribute: true
                },
                targetUrl: {
                    type: String,
                },
                animationConfig: {
                    value: function () {
                        return {
                            // provided by neon-animation/animations/scale-down-animation.html
                            name: 'scale-down-animation',
                            node: this.$.uploader
                        }
                    }
                },
            },
            listeners: {
                'installedTab.tap': 'switchToInstalled',
                'availableTab.tap': 'switchToAvailable',
                'neon-animation-finish': '_onNeonAnimationFinish',
                'libToggle.tap': '_onLibToggle'
            },

            attached: function () {
                this.selected = 0;
                this.listen(document, 'package-removed', '_handlePackageRemoved')
                this.listen(document, 'package-remove-error', '_handlePackageRemoveError')
                this.listen(document, 'package-installed', '_handlePackageInstalled')
                this.listen(document, 'package-install-error', '_handlePackageInstallError')
                this.listen(document, 'packagemanager-remove-attempt', '_handleRemoveAttempt')
                this.targetUrl = "/exist/apps/packagemanager/modules/install.xql"
                this.$.uploader.formDataName = "uploadedfiles[]"

                this.$.uploader.addEventListener('upload-before', function (event) {
                    console.log('upload xhr before open: ', event.detail.xhr);
                    var file = event.detail.file;
                    file.uploadTarget = '/exist/apps/packagemanager/modules/install.xql?name=' + file.name;
                });
                var that = this
                this.$.uploader.addEventListener('upload-success', function (e) {
                    console.log("onuploadsuccess", e)
                    var file = e.detail.file
                    var self = this
                    that.$.loadInstalled.generateRequest()
                    setTimeout(function () {
                        self.splice('files', self.files.indexOf(file), 1);
                    }, 1000)

                });
                this.$.uploader.addEventListener('upload-error', function (e) {
                    console.log("Upload error: ", e.detail)
                    this._toastError("Upload failed for: " + e.detail.file)
                });
                this.switchToInstalled()
            },

            detached: function () {
                this.unlisten(document, 'package-removed', '_handlePackageRemoved')
                this.unlisten(document, 'package-remove-error', '_handlePackageRemoveError')
                this.unlisten(document, 'package-installed', '_handlePackageInstalled')
                this.unlisten(document, 'package-install-error', '_handlePackageInstallError')
                this.unlisten(document, 'packagemanager-remove-attempt', '_handleRemoveAttempt')

            },

            handleLocalItems: function (data) {
                this.$.localItemList.innerHTML = this.$.loadInstalled.lastResponse
                this.$.leftprogress.value = 100
                var self = this;
                setTimeout(function () {
                    self.$.leftprogress.value = 0
                }, 600)

                this.$.leftprogress.indeterminate = false
                this.$.leftprogress.hidden=true
            },

            handleAvailableItems: function (data) {
                this.$.availableItemList.innerHTML = this.$.loadAvailable.lastResponse
                this.$.rightprogress.value = 100
                var self = this;
                setTimeout(function () {
                    self.$.rightprogress.value = 0
                }, 600)

                this.$.rightprogress.indeterminate = false
                this.$.rightprogress.hidden=true

            },

            showUpload: function (e) {
                this.$.upload.open();
            },


            switchToInstalled: function (e) {
                this.entryAnimation = 'slide-from-left-animation';
                this.exitAnimation = 'slide-right-animation';
                this.$.pages.selected = 0;
                this.$.leftprogress.indeterminate = true
                this.$.leftprogress.hidden=false
                this.$.loadInstalled.generateRequest();
            },

            switchToAvailable: function (e) {
                this.entryAnimation = 'slide-from-right-animation';
                this.exitAnimation = 'slide-left-animation';
                this.$.pages.selected = 1;
                console.log("location: ", location.host)
                this.$.rightprogress.indeterminate = true
                this.$.rightprogress.hidden=false
                this.$.loadAvailable.generateRequest();

            },

            _handlePackageRemoved: function (e) {
                this.$.loadInstalled.generateRequest()
                this._toast('Package has been removed: ' + e.detail.package)
            },

            _handlePackageRemoveError: function (e) {
                this._toastError(e.detail.error.error.message)
            },

            _handlePackageInstalled: function (e) {
                this._toast('Package has been installed: ' + e.detail.package)
//                this.selected=0;
                this.$.loadInstalled.generateRequest()
                this.selected = 0

            },
            _handlePackageInstallError: function (e) {
                this._toastError(e.detail.error.error.message)
            },

            _toast: function (msg) {
                this.$.toast.text = msg
                this.$.toast.open()
            },
            _toastError: function (msg) {
                this.$.toastError.text = msg
                this.$.toastError.open()
            },

            _onNeonAnimationFinish: function () {
                console.log('animation done!');
            },

            _handleLocalError:function (e) {
                console.log("loading of available packages failed", e.detail.error)
                this.$.leftprogress.indeterminate = false;
                this.$.leftprogress.value = 0;
                this._toastError('loading of available packages failed')
                this.$.leftprogress.hidden=true
            },

            _handleLoadAvailableError: function (e) {
                console.log("loading of available packages failed", e.detail.error)
                this.$.rightprogress.indeterminate = false;
                this.$.rightprogress.value = 0;
                this._toastError('loading of available packages failed')
                this.$.rightprogress.hidden=true
            },


            _hideToast: function (e) {
                this.$.toastError.hide()
            },

            _onLibToggle: function (e) {
                var pages = this.$.pages
                console.log(pages)
                if(pages.getAttribute('nolibs') == 'true'){
                    pages.setAttribute('nolibs','false')
                }else{
                    pages.setAttribute('nolibs','true')
                }
            },

            _switchGrid: function (e) {
                var hasGrid = this.$.localItemList.hasAttribute('grid')
                if(hasGrid){
                    this.$.localItemList.removeAttribute("grid")
                }else{
                    this.$.localItemList.setAttribute('grid','')
                }
            },

            _handleRemoveAttempt: function (e) {
                this._toastError("Package Manager cannot be removed.")
            }


            /*
             _onUploadProgress: function (e) {
             console.log("onprogress ", e.detail.file.progress)
             this.$.progress.value = e.detail.file.progress
             }
             */


        });
    </script>
</dom-module>
