<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/iron-form/iron-form.html">


<!--
`existdb-package-action`
implements an interaction with the package repository

@demo demo/index.html 
-->

<dom-module id="existdb-package-remove-action">
    <template>
        <style>
            :host {
                display: block;

                --paper-icon-button: {
                    color: var(--paper-blue-300);
                }

            }
        </style>
        <!--
                <iron-ajax id="removePackage"
                           verbose with-credentials
                           body='{"package-url": url, "abbrev": abbrev, "action":"remove","type":type}'
                           method="post" handle-as="json"
                           on-response="handleResponse"
                           on-error="handleError"
                           url="/exist/apps/packagemanager/modules/install.xql"
                           ></iron-ajax>
        -->

        <iron-ajax id="removePackage"
                   verbose with-credentials
                   method="post" handle-as="text"
                   on-response="_handleResponse"
                   url="/exist/apps/existdb-packageservice/packages/action"
                   on-error="_handleError"></iron-ajax>


        <paper-icon-button id="removeBtn" icon="delete" title="remove this package"></paper-icon-button>
        <form id="removeform" is="iron-form" method="post" action="/exist/apps/existdb-packageservice/packages/action">
            <input type="hidden" name="package-url" value="{{url}}"/>
            <input type="hidden" name="action" value="remove"/>
        </form>
    </template>

    <script>
        Polymer({

            is: 'existdb-package-remove-action',

            properties: {
                url: {
                    type: String,
                }
            },

            listeners: {
                'removeBtn.tap': 'submit',
                'iron-form-response': 'handleResponse',
                'iron-form-error': 'handleError'
            },

            attached: function(){
                console.log("url: ", this.url);
            },


            submit: function (e) {
                e.stopPropagation();
                e.preventDefault();

                console.log("the form: ", this.$.removeform.body);

                if (this.url.endsWith("/packagemanager")) {
                    this.fire("packagemanager-remove-attempt")
                    return
                }
                //do it
                console.log("submitting remove form: ", e);

                var r = confirm("Really remove this package?");
                if (r == true) {
                    this.$.removePackage.params = {"package-url":this.url, "action":"remove"};
                    this.$.removePackage.generateRequest();
                }
            },

            _handleResponse: function (data) {
                console.log("response: ", data)
                this.fire("package-removed", {package: this.url});
            },

            _handleError: function (e) {
                console.log("error: ", e)
                this.fire("package-remove-error", {"error": e.detail});
            }
        });
    </script>
</dom-module>
